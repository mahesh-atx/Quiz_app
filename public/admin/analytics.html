<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Analytics - QuizCraft Admin" />
    <title>Analytics - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="/css/styles.css" />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "system-ui", "sans-serif"],
            },
            colors: {
              brand: {
                50: "#eef2ff",
                100: "#e0e7ff",
                200: "#c7d2fe",
                300: "#a5b4fc",
                400: "#818cf8",
                500: "#6366f1",
                600: "#4f46e5",
                700: "#4338ca",
                800: "#3730a3",
                900: "#312e81",
              },
            },
          },
        },
      };
    </script>
  </head>
  <body class="font-sans bg-zinc-950 text-zinc-100 antialiased min-h-screen">
    <aside class="fixed left-0 top-0 h-full w-64 bg-zinc-900 border-r border-zinc-800 p-4 flex flex-col">
      <a href="/" class="flex items-center space-x-2 mb-8">
        <div class="w-10 h-10 bg-purple-500 rounded-xl flex items-center justify-center">
          <i data-lucide="shield" class="w-6 h-6 text-white"></i>
        </div>
        <span class="text-xl font-bold">Quiz<span class="text-purple-400">Craft</span></span>
      </a>

      <nav class="flex-1 space-y-1">
        <a href="/admin/dashboard.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-zinc-400 hover:bg-zinc-800 hover:text-zinc-100 transition-colors">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
          <span>Dashboard</span>
        </a>
        <a href="/admin/users.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-zinc-400 hover:bg-zinc-800 hover:text-zinc-100 transition-colors">
          <i data-lucide="users" class="w-5 h-5"></i>
          <span>Manage Users</span>
        </a>
        <a href="/admin/categories.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-zinc-400 hover:bg-zinc-800 hover:text-zinc-100 transition-colors">
          <i data-lucide="folder" class="w-5 h-5"></i>
          <span>Categories</span>
        </a>
        <a href="/admin/quizzes.html" class="flex items-center gap-3 px-4 py-3 rounded-xl text-zinc-400 hover:bg-zinc-800 hover:text-zinc-100 transition-colors">
          <i data-lucide="file-question" class="w-5 h-5"></i>
          <span>All Quizzes</span>
        </a>
        <a href="/admin/analytics.html" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-purple-500/10 text-purple-400 border border-purple-500/20">
          <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
          <span class="font-medium">Analytics</span>
        </a>
      </nav>

      <div class="border-t border-zinc-800 pt-4 mt-4">
        <div class="flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-zinc-800 cursor-pointer transition-colors">
          <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center">
            <span id="userInitial" class="font-semibold text-white">A</span>
          </div>
          <div class="flex-1 min-w-0">
            <p id="userName" class="font-medium truncate">Admin</p>
            <p class="text-xs text-zinc-500">Administrator</p>
          </div>
          <button id="logoutBtn" class="text-zinc-500 hover:text-red-400 transition-colors">
            <i data-lucide="log-out" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
    </aside>

    <main class="ml-64 p-8">
      <div class="mb-8">
        <h1 class="text-3xl font-bold mb-2">Platform Analytics</h1>
        <p class="text-zinc-400">Comprehensive platform statistics and insights</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-purple-500/10 rounded-xl flex items-center justify-center">
              <i data-lucide="users" class="w-6 h-6 text-purple-400"></i>
            </div>
          </div>
          <p class="text-3xl font-bold mb-1" id="totalTeachers">0</p>
          <p class="text-zinc-500 text-sm">Total Teachers</p>
        </div>

        <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-amber-500/10 rounded-xl flex items-center justify-center">
              <i data-lucide="file-question" class="w-6 h-6 text-amber-400"></i>
            </div>
          </div>
          <p class="text-3xl font-bold mb-1" id="totalQuizzes">0</p>
          <p class="text-zinc-500 text-sm">Total Quizzes</p>
        </div>

        <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-green-500/10 rounded-xl flex items-center justify-center">
              <i data-lucide="check-circle" class="w-6 h-6 text-green-400"></i>
            </div>
          </div>
          <p class="text-3xl font-bold mb-1" id="totalAttempts">0</p>
          <p class="text-zinc-500 text-sm">Total Attempts</p>
        </div>

        <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-6">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-brand-500/10 rounded-xl flex items-center justify-center">
              <i data-lucide="folder" class="w-6 h-6 text-brand-400"></i>
            </div>
          </div>
          <p class="text-3xl font-bold mb-1" id="totalCategories">0</p>
          <p class="text-zinc-500 text-sm">Total Categories</p>
        </div>
      </div>

      <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-6">
        <h2 class="text-xl font-bold mb-4">Platform Overview</h2>
        <div class="text-zinc-400 space-y-2">
          <p>ðŸ“Š Average Quiz Score: <span id="avgScore" class="text-zinc-100 font-semibold">--</span></p>
          <p>ðŸŽ¯ Platform Pass Rate: <span id="passRate" class="text-zinc-100 font-semibold">--</span></p>
          <p>ðŸ‘¥ Active Teachers: <span id="activeTeachers" class="text-zinc-100 font-semibold">--</span></p>
        </div>
      </div>
    </main>

    <script src="/js/auth.js"></script>
    <script>
      lucide.createIcons();
      let currentUser = null;

      async function initPage() {
        currentUser = await initAuth();
        if (currentUser && currentUser.role === "admin") {
          await loadAnalytics();
        } else {
          window.location.href = "/admin/dashboard.html";
        }
      }

      async function loadAnalytics() {
        try {
          const [teachersRes, quizzesRes, resultsRes, categoriesRes] = await Promise.all([
            fetch("/api/users/teachers?limit=1000", { credentials: "include" }),
            fetch("/api/quizzes?limit=1000", { credentials: "include" }),
            fetch("/api/results?limit=1000", { credentials: "include" }),
            fetch("/api/categories", { credentials: "include" }),
          ]);

          const teachersData = await teachersRes.json();
          const quizzesData = await quizzesRes.json();
          const resultsData = await resultsRes.json();
          const categoriesData = await categoriesRes.json();

          const teachers = teachersData.teachers || [];
          const quizzes = quizzesData.quizzes || [];
          const results = resultsData.data || [];
          const categories = categoriesData.categories || [];

          document.getElementById("totalTeachers").textContent = teachers.length;
          document.getElementById("totalQuizzes").textContent = quizzes.length;
          document.getElementById("totalAttempts").textContent = results.length;
          document.getElementById("totalCategories").textContent = categories.length;

          const avgScore = results.length > 0 
            ? Math.round(results.reduce((sum, r) => sum + r.percentage, 0) / results.length)
            : 0;
          document.getElementById("avgScore").textContent = avgScore + "%";

          const passRate = results.length > 0
            ? Math.round((results.filter(r => r.percentage >= 60).length / results.length) * 100)
            : 0;
          document.getElementById("passRate").textContent = passRate + "%";

          const activeTeachers = teachers.filter(t => t.isActive).length;
          document.getElementById("activeTeachers").textContent = activeTeachers;

        } catch (error) {
          console.error("Load analytics error:", error);
        }
      }

      document.getElementById("logoutBtn").addEventListener("click", async () => {
        try {
          await fetch("/api/auth/logout", {
            method: "POST",
            credentials: "include",
          });
        } catch (e) {
          console.error("Logout error:", e);
        }
        localStorage.removeItem("user");
        window.location.href = "/login.html";
      });

      initPage();
    </script>
  </body>
</html>